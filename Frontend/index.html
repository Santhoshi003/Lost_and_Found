<!DOCTYPE html>
<html lang="en" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoundIt - Lost & Found Hub (Dynamic)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Default font */
            @apply bg-gray-50 text-gray-700 dark:bg-gray-900 dark:text-gray-300 transition-colors duration-300;
        }
        .poppins-font {
            font-family: 'Poppins', sans-serif;
        }
        .hero-bg {
            background-image: linear-gradient(to right, rgba(29, 78, 216, 0.8), rgba(30, 64, 175, 0.8)), url('https://images.unsplash.com/photo-1526659563991-98b14e4a20b3?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        html {
            scroll-behavior: smooth;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal-content {
            animation: slide-down 0.3s ease-out;
        }
        @keyframes slide-down {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .chat-bubble {
            animation: fade-in 0.5s ease-in-out;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Tab styling */
        .admin-tab.active {
            @apply border-indigo-400 text-indigo-300;
        }
        /* Make admin user rows clickable */
        #admin-users-table tbody tr {
            @apply cursor-pointer;
        }
    </style>
</head>
<body>

    <div id="app-content"></div>

    <div id="chatbot-container" class="fixed bottom-5 right-5 z-50">
        <button id="chatbot-toggle" class="bg-indigo-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-110">
            <i class="fas fa-robot text-2xl"></i>
        </button>
        <div id="chatbot-window" class="hidden absolute bottom-20 right-0 w-80 md:w-96 bg-white rounded-lg shadow-2xl chat-bubble dark:bg-gray-800">
            <div class="bg-indigo-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="font-bold">AI Assistant</h3>
                <button id="close-chatbot" class="text-white">&times;</button>
            </div>
            <div id="chatbot-messages" class="p-4 h-80 overflow-y-auto">
                <div class="flex justify-start mb-2">
                    <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs dark:bg-gray-700 dark:text-gray-200">
                        <p>Hello! How can I help you navigate the FoundIt portal today?</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex dark:border-gray-700">
                <input type="text" id="chatbot-input" class="flex-grow border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600" placeholder="Ask a question...">
                <button id="chatbot-send" class="bg-indigo-600 text-white px-4 rounded-r-lg hover:bg-indigo-700">Send</button>
            </div>
        </div>
    </div>

    <!-- BUG FIX: Removed display classes like 'flex' to ensure modals are hidden by default -->
    <div id="notification-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[100]">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center dark:bg-gray-800">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Notification</h3>
            <p id="modal-message" class="mb-6 text-gray-600 dark:text-gray-300"></p>
            <button id="modal-close" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Close</button>
        </div>
    </div>

    <!-- BUG FIX: Removed display classes like 'items-center' to ensure modals are hidden by default -->
    <div id="user-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[100]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 dark:bg-gray-800">
             <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">User Details</h3>
                <button id="user-modal-close" class="text-gray-500 dark:text-gray-300 text-2xl font-bold">&times;</button>
             </div>
             <div id="user-modal-body" class="p-6 space-y-2">
                 </div>
        </div>
    </div>


    <script type="module">
        // --- DYNAMIC DATA & STATE MANAGEMENT (Using Browser Storage) ---
        const getStorage = (key) => JSON.parse(localStorage.getItem(key) || 'null');
        const setStorage = (key, value) => localStorage.setItem(key, JSON.stringify(value));

        function initializeStorage() {
            if (!getStorage('foundit_users')) {
                let mockUsers = {
                    "user@example.com": { id: "user123", name: "Alex Doe", email: "user@example.com", password: "password123", collegeId: "C012345", address: "123 Oak St, Anytown", phoneNumber: "555-0101" },
                    "jane@example.com": { id: "user456", name: "Jane Smith", email: "jane@example.com", password: "password123", collegeId: "C054321", address: "456 Pine Ave, Anytown", phoneNumber: "555-0102" },
                    "test@example.com": { id: "user789", name: "Test User", email: "test@example.com", password: "password123", collegeId: "C098765", address: "789 Maple Dr, Anytown", phoneNumber: "555-0103" },
                    "admin@example.com": { id: "admin456", name: "Admin", email: "admin@example.com", password: "adminpassword", collegeId: "N/A", address: "Admin Building", phoneNumber: "555-0100" }
                };
                setStorage('foundit_users', mockUsers);
            }
            if (!getStorage('foundit_items')) {
                let mockItems = [
                    { id: 'found001', type: 'found', name: 'iPhone 14 Pro', description: 'Black, in a clear case with a small crack on the back.', location: 'Library, 2nd Floor', dropoffLocation: 'Admin Office', imageUrl: 'https://placehold.co/600x400/e2e8f0/64748b?text=iPhone', status: 'available', reporterId: 'user123', reporterEmail: 'user@example.com', createdAt: new Date('2025-07-28T10:00:00Z').toISOString() },
                    { id: 'found002', type: 'found', name: 'Blue Water Bottle', description: 'HydroFlask brand, covered in various stickers. One sticker is of a cat.', location: 'Cafeteria', dropoffLocation: 'Security Office', imageUrl: 'https://placehold.co/600x400/e2e8f0/64748b?text=Bottle', status: 'available', reporterId: 'user123', reporterEmail: 'user@example.com', createdAt: new Date('2025-07-27T14:30:00Z').toISOString() },
                    { id: 'lost001', type: 'lost', name: 'Car Keys', description: 'Toyota key fob with a small keychain that has a red heart.', location: 'Parking Lot B', imageUrl: '', status: 'reported', reporterId: 'user123', reporterEmail: 'user@example.com', createdAt: new Date('2025-07-26T09:00:00Z').toISOString() },
                    { id: 'lost002', type: 'lost', name: 'Black iPhone', description: 'Has a clear case, the back is cracked.', location: 'Library Main Hall', imageUrl: '', status: 'reported', reporterId: 'user456', reporterEmail: 'jane@example.com', createdAt: new Date('2025-07-28T11:00:00Z').toISOString() },
                    { id: 'found003', type: 'found', name: 'Red Scarf', description: 'Wool scarf, looks handmade.', location: 'Student Union Bench', dropoffLocation: 'Student Union', imageUrl: 'https://placehold.co/600x400/e2e8f0/64748b?text=Scarf', status: 'returned', reporterId: 'user789', reporterEmail: 'test@example.com', createdAt: new Date('2025-07-24T12:00:00Z').toISOString() }
                ];
                setStorage('foundit_items', mockItems);
            }
            if (!getStorage('foundit_feedback')) {
                 let mockFeedback = [
                    { userEmail: "user@example.com", message: "This platform is amazing! Found my keys in a day.", createdAt: new Date().toISOString() },
                    { userEmail: "jane@example.com", message: "The UI is very clean and easy to use. Great job!", createdAt: new Date().toISOString() }
                ];
                setStorage('foundit_feedback', mockFeedback);
            }
        }
        
        // --- STATE VARIABLES ---
        let currentUser = JSON.parse(sessionStorage.getItem('foundit_currentUser') || 'null');
        let isAdmin = sessionStorage.getItem('foundit_isAdmin') === 'true';

        // --- UI & ROUTING ---
        const appContent = document.getElementById('app-content');
        
        const routes = {
            '/': welcomePage,
            '/auth': authPage,
            '/about': aboutUsPage,
            '/contact': contactUsPage,
            '/dashboard': userHomePage,
            '/admin': adminDashboard,
            '/lost': lostItemPage,
            '/found': foundItemPage,
            '/view-items': viewItemsPage,
            '/my-items': myItemsPage,
            '/profile': userProfilePage,
        };

        function navigate(path) {
            window.location.hash = path.substring(1);
        }
        window.navigate = navigate;

        function router() {
            const path = '/' + (window.location.hash.substring(1) || '');
            
            const protectedRoutes = ['/dashboard', '/admin', '/lost', '/found', '/view-items', '/my-items', '/profile'];
            if (!currentUser && protectedRoutes.includes(path)) {
                navigate('/auth');
                return;
            }
            if(currentUser && !isAdmin && path === '/admin') {
                navigate('/dashboard');
                return;
            }
             if(currentUser && isAdmin && !path.startsWith('/admin')) {
                navigate('/admin');
                return;
            }

            const pageRenderer = routes[path] || routes['/'];
            const activePath = routes[path] ? path : '/';
            
            appContent.innerHTML = pageRenderer();
            attachEventListeners(activePath);
        }

        // --- PAGE TEMPLATES ---

        function commonHeader(isLoggedIn = false) {
            const homePath = isLoggedIn ? (isAdmin ? '/admin' : '/dashboard') : '/';
            return `
                <header class="bg-white shadow-md sticky top-0 z-40 poppins-font dark:bg-gray-800 dark:border-b dark:border-gray-700">
                    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-blue-700 dark:text-blue-400 cursor-pointer" onclick="navigate('${homePath}')">
                            FoundIt<span class="text-yellow-400 text-2xl">⭐</span>
                        </h1>
                        <nav class="hidden md:flex items-center space-x-6">
                            <button onclick="navigate('/about')" class="text-gray-600 hover:text-blue-700 dark:text-gray-300 dark:hover:text-blue-400 font-medium">About Us</button>
                            <button onclick="navigate('/contact')" class="text-gray-600 hover:text-blue-700 dark:text-gray-300 dark:hover:text-blue-400 font-medium">Contact</button>
                            ${isLoggedIn ? 
                                `<button id="logout-btn-header" class="bg-red-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-red-600">Logout</button>` :
                                `<button onclick="navigate('/auth')" class="bg-blue-600 text-white px-5 py-2 rounded-full font-semibold hover:bg-blue-700">Login / Sign Up</button>`
                            }
                        </nav>
                        <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                    </div>
                    <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 bg-white dark:bg-gray-800">
                        <button onclick="navigate('/about')" class="block w-full text-left py-2 text-gray-600 dark:text-gray-300 hover:text-blue-700 dark:hover:text-blue-400">About Us</button>
                        <button onclick="navigate('/contact')" class="block w-full text-left py-2 text-gray-600 dark:text-gray-300 hover:text-blue-700 dark:hover:text-blue-400">Contact</button>
                        ${isLoggedIn ? 
                            `<button id="logout-btn-mobile" class="block w-full text-left mt-2 bg-red-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-red-700">Logout</button>` :
                            `<button onclick="navigate('/auth')" class="block w-full text-left mt-2 bg-blue-600 text-white px-5 py-2 rounded-full font-semibold hover:bg-blue-700">Login / Sign Up</button>`
                        }
                    </div>
                </header>
            `;
        }

        function commonFooter() {
             return `
                <footer class="bg-gray-800 text-white poppins-font">
                    <div class="container mx-auto px-6 py-8 text-center">
                        <h2 class="text-2xl font-bold">
                            FoundIt<span class="text-yellow-400 text-xl">⭐</span>
                        </h2>
                        <p class="mt-4">Making our community a little more connected.</p>
                        <p class="mt-4 text-sm text-gray-400">&copy; ${new Date().getFullYear()} FoundIt. All Rights Reserved.</p>
                    </div>
                </footer>
            `;
        }

        function welcomePage() {
            return `
                <div class="poppins-font">
                    ${commonHeader()}
                    <main>
                        <section class="hero-bg text-white h-[calc(100vh-76px)] flex items-center">
                            <div class="container mx-auto px-6 text-center">
                                <h2 class="text-4xl md:text-6xl font-bold leading-tight mb-4">Lost Something? Find it Here.</h2>
                                <p class="text-lg md:text-xl text-blue-100 mb-8 max-w-3xl mx-auto">The easiest way to reconnect with your lost belongings. From keys and wallets to your favorite headphones, your community is here to help.</p>
                                <button onclick="navigate('/auth')" class="bg-white text-blue-700 px-8 py-4 rounded-full font-bold text-lg hover:bg-gray-200 transition duration-300 transform hover:scale-105">Get Started</button>
                            </div>
                        </section>
                    </main>
                    ${commonFooter()}
                </div>
            `;
        }
        
        function aboutUsPage() {
            return `
                <div class="poppins-font">
                    ${commonHeader(!!currentUser)}
                    <main class="bg-white dark:bg-gray-900 min-h-[calc(100vh-152px)]">
                        <section id="about" class="py-20">
                            <div class="container mx-auto px-6">
                                <h3 class="text-4xl font-bold text-center mb-12 text-gray-800 dark:text-white">About FoundIt</h3>
                                <div class="max-w-4xl mx-auto text-center text-gray-600 dark:text-gray-300 text-lg">
                                    <p class="mb-6">We've all felt that sinking feeling of realizing something important is missing. At FoundIt, our mission is to turn that moment of panic into a sigh of relief. We provide a simple, centralized platform for communities—be it a college campus, a residential complex, or an office building—to report lost and found items.</p>
                                    <p>By connecting finders with owners, we aim to build a more honest and helpful environment, one recovered item at a time. Our platform is designed to be intuitive, secure, and effective, making the process of recovering your daily use items as painless as possible.</p>
                                </div>
                            </div>
                        </section>
                    </main>
                    ${commonFooter()}
                </div>
            `;
        }

        function contactUsPage() {
             return `
                <div class="poppins-font">
                    ${commonHeader(!!currentUser)}
                    <main class="bg-gray-100 dark:bg-gray-900 min-h-[calc(100vh-152px)]">
                        <section id="contact" class="py-20">
                            <div class="container mx-auto px-6">
                                <h3 class="text-4xl font-bold text-center mb-12 text-gray-800 dark:text-white">Get In Touch</h3>
                                <div class="max-w-lg mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                                    <p class="text-center text-gray-600 dark:text-gray-300 mb-6">Have questions, suggestions, or need help? We'd love to hear from you. Reach out to us through any of the channels below.</p>
                                    <div class="space-y-4">
                                        <div class="flex items-center"><i class="fas fa-envelope w-6 h-6 text-blue-600 dark:text-blue-400 mr-4"></i><a href="mailto:contact@foundit.com" class="text-lg text-gray-700 dark:text-gray-200 hover:text-blue-700 dark:hover:text-blue-400">contact@foundit.com</a></div>
                                        <div class="flex items-center"><i class="fas fa-phone w-6 h-6 text-blue-600 dark:text-blue-400 mr-4"></i><span class="text-lg text-gray-700 dark:text-gray-200">+91 123-456-7890</span></div>
                                        <div class="flex items-center"><i class="fas fa-map-marker-alt w-6 h-6 text-blue-600 dark:text-blue-400 mr-4"></i><span class="text-lg text-gray-700 dark:text-gray-200">Surampalem, Andhra Pradesh, India</span></div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </main>
                    ${commonFooter()}
                </div>
            `;
        }
        
        function authPage() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-200 dark:bg-gray-900">
                    <div class="w-full max-w-md">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 border border-gray-300 dark:border-gray-700">
                            <div id="auth-container">
                                </div>
                            <button onclick="navigate('/')" class="w-full mt-4 text-sm text-gray-600 dark:text-gray-400 hover:underline">← Back to Welcome</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function userHomePage() {
            return `
                <div class="min-h-screen bg-gray-100 dark:bg-gray-900">
                    ${commonHeader(true)}
                    <main class="container mx-auto p-8">
                        <h2 class="text-4xl font-bold mb-4 text-center text-gray-800 dark:text-white">Welcome, ${currentUser?.name || 'User'}!</h2>
                        <p class="text-center text-gray-600 dark:text-gray-400 mb-12">What would you like to do today?</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                            <div onclick="navigate('/lost')" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer transform hover:-translate-y-1">
                                <i class="fas fa-search text-6xl text-red-500 mb-6"></i>
                                <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-white">Lost Something?</h3>
                                <p class="text-gray-600 dark:text-gray-400">File a lost item report.</p>
                            </div>
                            <div onclick="navigate('/found')" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer transform hover:-translate-y-1">
                                <i class="fas fa-hand-holding-heart text-6xl text-green-500 mb-6"></i>
                                <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-white">Found Something?</h3>
                                <p class="text-gray-600 dark:text-gray-400">Report a found item.</p>
                            </div>
                             <div onclick="navigate('/view-items')" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer transform hover:-translate-y-1">
                                <i class="fas fa-eye text-6xl text-indigo-500 mb-6"></i>
                                <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-white">View Items</h3>
                                <p class="text-gray-600 dark:text-gray-400">Browse found items.</p>
                            </div>
                            <div onclick="navigate('/my-items')" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer transform hover:-translate-y-1">
                                <i class="fas fa-list-alt text-6xl text-purple-500 mb-6"></i>
                                <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-white">My Reports</h3>
                                <p class="text-gray-600 dark:text-gray-400">Manage your reports.</p>
                            </div>
                            <div onclick="navigate('/profile')" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer transform hover:-translate-y-1">
                                <i class="fas fa-user-cog text-6xl text-teal-500 mb-6"></i>
                                <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-white">My Profile</h3>
                                <p class="text-gray-600 dark:text-gray-400">View or edit your profile.</p>
                            </div>
                            <div id="feedback-btn" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer transform hover:-translate-y-1">
                                <i class="fas fa-comment-dots text-6xl text-yellow-500 mb-6"></i>
                                <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-white">Have Feedback?</h3>
                                <p class="text-gray-600 dark:text-gray-400">Help us improve.</p>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }
        
        function lostItemPage() {
            return `
                <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
                    ${commonHeader(true)}
                    <div class="container mx-auto p-8">
                        <button onclick="navigate(isAdmin ? '/admin' : '/dashboard')" class="mb-6 text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Back to Dashboard</button>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 dark:text-white">Report a Lost Item</h2>
                        <form id="lost-item-form" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                            <div class="mb-4"><label for="lost-item-name" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Item Name</label><input type="text" id="lost-item-name" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., Black Backpack" required></div>
                            <div class="mb-4"><label for="lost-item-desc" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Description</label><textarea id="lost-item-desc" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" rows="4" placeholder="Add details like brand, color, identifying marks..." required></textarea></div>
                            <div class="mb-4"><label for="lost-item-location" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Last Seen Location</label><input type="text" id="lost-item-location" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., Library, 2nd Floor" required></div>
                            <div class="mb-6"><label for="lost-item-image" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Image (if you have one)</label><input type="file" id="lost-item-image" accept="image/*" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:bg-gray-700 dark:file:bg-indigo-900/50 dark:file:text-indigo-300 dark:hover:file:bg-indigo-900"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Submit Report</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function foundItemPage() {
            return `
                <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
                    ${commonHeader(true)}
                     <div class="container mx-auto p-8">
                        <button onclick="navigate(isAdmin ? '/admin' : '/dashboard')" class="mb-6 text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Back to Dashboard</button>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 dark:text-white">Report a Found Item</h2>
                        <form id="found-item-form" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                            <div class="mb-4"><label for="found-item-name" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Item Name</label><input type="text" id="found-item-name" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., iPhone 13" required></div>
                            <div class="mb-4"><label for="found-item-desc" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Description</label><textarea id="found-item-desc" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" rows="4" placeholder="Describe the item..." required></textarea></div>
                            <div class="mb-4"><label for="found-item-location" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Location Found</label><input type="text" id="found-item-location" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., Near Cafeteria" required></div>
                            <div class="mb-4"><label for="dropoff-location" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Drop-off Location</label><select id="dropoff-location" class="w-full p-2 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required><option value="">Select a drop-off point</option><option value="Admin Office">Admin Office</option><option value="Library Desk">Library Desk</option><option value="Security Office">Security Office</option><option value="Student Union">Student Union</option></select></div>
                            <div class="mb-6"><label for="found-item-image" class="block font-semibold mb-2 text-gray-700 dark:text-gray-300">Image of Item (Required)</label><input type="file" id="found-item-image" accept="image/*" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:bg-gray-700 dark:file:bg-indigo-900/50 dark:file:text-indigo-300 dark:hover:file:bg-indigo-900" required></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Submit Report</button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        function viewItemsPage() {
            return `
                <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
                    ${commonHeader(true)}
                    <div class="container mx-auto p-8">
                        <button onclick="navigate(isAdmin ? '/admin' : '/dashboard')" class="mb-6 text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Back to Dashboard</button>
                        <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Found Items Gallery</h2>
                        <div id="items-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            </div>
                    </div>
                </div>
            `;
        }
        
        function myItemsPage() {
            return `
                <div class="min-h-screen bg-gray-100 dark:bg-gray-900">
                    ${commonHeader(true)}
                    <div class="container mx-auto p-8">
                        <button onclick="navigate(isAdmin ? '/admin' : '/dashboard')" class="mb-6 text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Back to Dashboard</button>
                        <h2 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white">My Reported Items</h2>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
                            <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2 text-red-600">My Lost Items</h3>
                            <div id="my-lost-items" class="space-y-4"></div>
                            <h3 class="text-xl font-semibold mb-4 mt-8 border-b border-gray-200 dark:border-gray-700 pb-2 text-green-600">My Found Items</h3>
                            <div id="my-found-items" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function userProfilePage() {
            const allItems = getStorage('foundit_items') || [];
            const lostCount = allItems.filter(item => item.reporterId === currentUser.id && item.type === 'lost').length;
            const foundCount = allItems.filter(item => item.reporterId === currentUser.id && item.type === 'found').length;

            return `
                 <div class="min-h-screen bg-gray-100 dark:bg-gray-900">
                    ${commonHeader(true)}
                    <div class="container mx-auto p-8">
                        <button onclick="navigate(isAdmin ? '/admin' : '/dashboard')" class="mb-6 text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Back to Dashboard</button>
                        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl">
                            <h2 class="text-3xl font-bold mb-6 text-gray-800 dark:text-white">My Profile</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="md:col-span-1 text-center">
                                    <i class="fas fa-user-circle text-8xl text-indigo-500"></i>
                                    <h3 class="text-2xl font-bold mt-4 text-gray-800 dark:text-white">${currentUser.name}</h3>
                                    <p class="text-gray-500 dark:text-gray-400">${currentUser.collegeId}</p>
                                </div>
                                <div class="md:col-span-2">
                                    <h4 class="text-xl font-semibold border-b dark:border-gray-700 pb-2 mb-4 text-gray-800 dark:text-white">Details</h4>
                                    <div class="space-y-3 text-gray-700 dark:text-gray-300">
                                        <p><strong class="w-24 inline-block text-gray-500 dark:text-gray-400">Email:</strong> ${currentUser.email}</p>
                                        <p><strong class="w-24 inline-block text-gray-500 dark:text-gray-400">Phone:</strong> ${currentUser.phoneNumber}</p>
                                        <p><strong class="w-24 inline-block text-gray-500 dark:text-gray-400">Address:</strong> ${currentUser.address}</p>
                                    </div>

                                    <h4 class="text-xl font-semibold border-b dark:border-gray-700 pb-2 mt-8 mb-4 text-gray-800 dark:text-white">Activity</h4>
                                    <div class="flex space-x-8">
                                        <div><strong class="text-2xl text-red-500">${lostCount}</strong><p class="text-gray-500 dark:text-gray-400">Items Lost</p></div>
                                        <div><strong class="text-2xl text-green-500">${foundCount}</strong><p class="text-gray-500 dark:text-gray-400">Items Found</p></div>
                                    </div>
                                    
                                    <div class="mt-8">
                                         <button id="change-password-btn" class="bg-gray-600 text-white px-5 py-2 rounded-lg hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600">Change Password</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function adminDashboard() {
            return `
                <div class="min-h-screen bg-gray-200 text-gray-700 dark:bg-gray-900 dark:text-gray-300">
                    <nav class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
                        <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Admin Panel</h1>
                        <div class="flex items-center space-x-4">
                             <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400">
                                <i class="fas fa-moon text-xl"></i> </button>
                             <button id="notification-bell" class="relative text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400">
                                <i class="fas fa-bell text-xl"></i>
                            </button>
                            <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Logout</button>
                        </div>
                    </nav>
                    <div class="container mx-auto p-4 sm:p-8">
                        <div class="border-b border-gray-300 dark:border-gray-700 mb-6">
                            <nav class="flex space-x-4 overflow-x-auto" aria-label="Tabs">
                                <button data-tab="items" class="admin-tab active whitespace-nowrap px-3 py-2 font-medium text-sm rounded-md border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">Manage Items</button>
                                <button data-tab="users" class="admin-tab whitespace-nowrap px-3 py-2 font-medium text-sm rounded-md border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">Manage Users</button>
                                <button data-tab="feedback" class="admin-tab whitespace-nowrap px-3 py-2 font-medium text-sm rounded-md border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">View Feedback</button>
                                <button data-tab="matching" class="admin-tab whitespace-nowrap px-3 py-2 font-medium text-sm rounded-md border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">Match Suggestions</button>
                            </nav>
                        </div>

                        <div id="admin-content-area">
                            </div>
                    </div>
                </div>
            `;
        }
        
        // --- EVENT LISTENERS & LOGIC ---
        
        function attachEventListeners(path) {
            document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
                 document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('logout-btn-header')?.addEventListener('click', handleLogout);
            document.getElementById('logout-btn-mobile')?.addEventListener('click', handleLogout);

            document.getElementById('user-modal-close')?.addEventListener('click', () => {
                const modal = document.getElementById('user-details-modal');
                modal.style.display = 'none';
                modal.classList.remove('flex', 'items-center', 'justify-center');
            });

            if (path === '/auth') attachAuthListeners();
            if (path === '/lost') document.getElementById('lost-item-form').addEventListener('submit', handleLostItemSubmit);
            if (path === '/found') document.getElementById('found-item-form').addEventListener('submit', handleFoundItemSubmit);
            if (path === '/view-items') loadFoundItems();
            if (path === '/my-items') loadMyItems();
            if (path === '/admin') attachAdminListeners();
            if (path === '/dashboard') {
                document.getElementById('feedback-btn')?.addEventListener('click', handleFeedbackSubmit);
            }
            if (path === '/profile') {
                document.getElementById('change-password-btn')?.addEventListener('click', handleChangePassword);
            }
        }
        
        function attachAuthListeners() {
            const authContainer = document.getElementById('auth-container');

            const renderLoginForm = () => {
                authContainer.innerHTML = `
                    <div class="flex justify-center mb-6">
                        <button id="user-tab" class="px-6 py-2 font-semibold text-lg border-b-2 border-indigo-600 text-indigo-600 dark:border-indigo-400 dark:text-indigo-400">User</button>
                        <button id="admin-tab" class="px-6 py-2 font-semibold text-lg text-gray-500 dark:text-gray-400">Admin</button>
                    </div>
                    <div id="user-form">
                        <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-2">User Portal</h2>
                        <form id="login-form">
                            <div class="mb-4"><label class="block mb-2 text-gray-700 dark:text-gray-300" for="email">Email</label><input type="email" id="email" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required value="user@example.com"></div>
                            <div class="mb-6"><label class="block mb-2 text-gray-700 dark:text-gray-300" for="password">Password</label><input type="password" id="password" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required value="password123"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Login</button>
                        </form>
                    </div>
                    <div id="admin-form" class="hidden">
                         <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">Admin Login</h2>
                         <form id="admin-login-form">
                            <div class="mb-4"><label class="block mb-2 text-gray-700 dark:text-gray-300" for="admin-email">Admin Email</label><input type="email" id="admin-email" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required value="admin@example.com"></div>
                            <div class="mb-6"><label class="block mb-2 text-gray-700 dark:text-gray-300" for="admin-password">Password</label><input type="password" id="admin-password" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required value="adminpassword"></div>
                            <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-black dark:bg-indigo-600 dark:hover:bg-indigo-700">Login as Admin</button>
                        </form>
                    </div>
                    <p class="text-center mt-4">Don't have an account? <button id="switch-to-signup" class="text-indigo-600 dark:text-indigo-400 hover:underline">Sign Up</button></p>
                `;
                const userTab = document.getElementById('user-tab');
                const adminTab = document.getElementById('admin-tab');
                const userForm = document.getElementById('user-form');
                const adminForm = document.getElementById('admin-form');
                
                userTab.addEventListener('click', () => {
                    userForm.style.display = 'block';
                    adminForm.style.display = 'none';
                    userTab.classList.add('border-indigo-600', 'text-indigo-600');
                    adminTab.classList.remove('border-indigo-600', 'text-indigo-600');
                });
                adminTab.addEventListener('click', () => {
                    userForm.style.display = 'none';
                    adminForm.style.display = 'block';
                    adminTab.classList.add('border-indigo-600', 'text-indigo-600');
                    userTab.classList.remove('border-indigo-600', 'text-indigo-600');
                });
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
                document.getElementById('switch-to-signup').addEventListener('click', renderSignupForm);
            };

            const renderSignupForm = () => {
                authContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">Create an Account</h2>
                    <form id="signup-form" class="space-y-4">
                        <div><label class="block mb-1 text-gray-700 dark:text-gray-300">Full Name</label><input type="text" id="signup-name" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div>
                        <div><label class="block mb-1 text-gray-700 dark:text-gray-300">College ID</label><input type="text" id="signup-collegeId" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div>
                        <div><label class="block mb-1 text-gray-700 dark:text-gray-300">Email</label><input type="email" id="signup-email" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div>
                        <div><label class="block mb-1 text-gray-700 dark:text-gray-300">Phone Number</label><input type="tel" id="signup-phone" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div>
                        <div><label class="block mb-1 text-gray-700 dark:text-gray-300">Address</label><input type="text" id="signup-address" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div>
                        <div><label class="block mb-1 text-gray-700 dark:text-gray-300">Password</label><input type="password" id="signup-password" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required></div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Sign Up</button>
                    </form>
                    <p class="text-center mt-4">Already have an account? <button id="switch-to-login" class="text-indigo-600 dark:text-indigo-400 hover:underline">Login</button></p>
                `;
                document.getElementById('signup-form').addEventListener('submit', handleUserSignUp);
                document.getElementById('switch-to-login').addEventListener('click', renderLoginForm);
            };
            
            renderLoginForm();
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const users = getStorage('foundit_users');
            const user = users[email];
            if (user && user.password === password && user.id !== "admin456") {
                currentUser = user;
                isAdmin = false;
                sessionStorage.setItem('foundit_currentUser', JSON.stringify(currentUser));
                sessionStorage.setItem('foundit_isAdmin', 'false');
                navigate('/dashboard');
            } else {
                showNotification("Error: Invalid user credentials.");
            }
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const users = getStorage('foundit_users');
            const user = users[email];
            if (user && user.password === password && user.id === "admin456") {
                currentUser = user;
                isAdmin = true;
                sessionStorage.setItem('foundit_currentUser', JSON.stringify(currentUser));
                sessionStorage.setItem('foundit_isAdmin', 'true');
                navigate('/admin');
            } else {
                showNotification("Error: Invalid admin credentials.");
            }
        }

        function handleUserSignUp(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const users = getStorage('foundit_users');
            if(users[email]) {
                showNotification("Error: A user with this email already exists.");
                return;
            }
            const newUser = {
                id: `user${Date.now()}`,
                name: document.getElementById('signup-name').value,
                collegeId: document.getElementById('signup-collegeId').value,
                email: email,
                phoneNumber: document.getElementById('signup-phone').value,
                address: document.getElementById('signup-address').value,
                password: document.getElementById('signup-password').value,
            };
            users[email] = newUser;
            setStorage('foundit_users', users);
            showNotification("Account created successfully! Please log in.", true);
            attachAuthListeners();
        }

        function handleLogout() {
            currentUser = null;
            isAdmin = false;
            sessionStorage.removeItem('foundit_currentUser');
            sessionStorage.removeItem('foundit_isAdmin');
            navigate('/');
        }
        
        function handleFeedbackSubmit() {
            const feedbackText = prompt("Please enter your feedback:");
            if (feedbackText && feedbackText.trim() !== "") {
                const feedbackData = getStorage('foundit_feedback') || [];
                feedbackData.push({
                    userEmail: currentUser.email,
                    message: feedbackText,
                    createdAt: new Date().toISOString()
                });
                setStorage('foundit_feedback', feedbackData);
                showNotification("Thank you for your feedback!");
            }
        }

        function handleChangePassword() {
            const oldPassword = prompt("Enter your current password:");
            if(oldPassword === null) return;
            if (oldPassword !== currentUser.password) {
                showNotification("Incorrect password.", true);
                return;
            }
            const newPassword = prompt("Enter your new password:");
            if(newPassword === null) return;
            if (newPassword && newPassword.length >= 6) {
                const users = getStorage('foundit_users');
                users[currentUser.email].password = newPassword;
                currentUser.password = newPassword;
                setStorage('foundit_users', users);
                sessionStorage.setItem('foundit_currentUser', JSON.stringify(currentUser));
                showNotification("Password changed successfully.", true);
            } else {
                showNotification("Password must be at least 6 characters long.", true);
            }
        }
        
        const readFileAsDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        async function handleLostItemSubmit(e) {
            e.preventDefault();
            const imageFile = document.getElementById('lost-item-image').files[0];
            let imageUrl = 'https://placehold.co/600x400/e2e8f0/64748b?text=No+Image';
            if(imageFile) {
                imageUrl = await readFileAsDataURL(imageFile);
            }
            const newItem = {
                id: `lost${Date.now()}`,
                type: 'lost',
                name: document.getElementById('lost-item-name').value,
                description: document.getElementById('lost-item-desc').value,
                location: document.getElementById('lost-item-location').value,
                imageUrl: imageUrl,
                status: 'reported',
                reporterId: currentUser.id,
                reporterEmail: currentUser.email,
                createdAt: new Date().toISOString()
            };
            const items = getStorage('foundit_items') || [];
            items.push(newItem);
            setStorage('foundit_items', items);
            showNotification("Lost item report submitted successfully!");
            navigate('/my-items');
        }

        async function handleFoundItemSubmit(e) {
            e.preventDefault();
            const imageFile = document.getElementById('found-item-image').files[0];
            let imageUrl = 'https://placehold.co/600x400/e2e8f0/64748b?text=Item+Image';
            if(imageFile) {
                imageUrl = await readFileAsDataURL(imageFile);
            }
            const newItem = {
                id: `found${Date.now()}`,
                type: 'found',
                name: document.getElementById('found-item-name').value,
                description: document.getElementById('found-item-desc').value,
                location: document.getElementById('found-item-location').value,
                dropoffLocation: document.getElementById('dropoff-location').value,
                imageUrl: imageUrl,
                status: 'available',
                reporterId: currentUser.id,
                reporterEmail: currentUser.email,
                createdAt: new Date().toISOString()
            };
            const items = getStorage('foundit_items') || [];
            items.push(newItem);
            setStorage('foundit_items', items);
            showNotification("Found item report submitted successfully!");
            navigate('/my-items');
        }
        
        function loadFoundItems() {
            const gallery = document.getElementById('items-gallery');
            const allItems = getStorage('foundit_items') || [];
            const foundItems = allItems.filter(item => item.type === 'found' && item.status === 'available');
            
            gallery.innerHTML = '';
            if (foundItems.length === 0) {
                gallery.innerHTML = '<p class="text-gray-500 col-span-full text-center">No found items have been reported yet. Check back later!</p>';
                return;
            }
            
            foundItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex flex-col';
                itemEl.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Image+Error';">
                    <h3 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">${item.name}</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-2 flex-grow">${item.description}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1"><span class="font-semibold">Found at:</span> ${item.location}</p>
                    <p class="text-sm text-green-600 font-semibold"><span class="font-semibold text-gray-500 dark:text-gray-400">Drop-off:</span> ${item.dropoffLocation}</p>
                    <button class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 claim-btn" data-id="${item.id}">Claim Item</button>
                `;
                gallery.appendChild(itemEl);
            });
            
            document.querySelectorAll('.claim-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    const items = getStorage('foundit_items');
                    const itemIndex = items.findIndex(i => i.id === itemId);
                    if (itemIndex > -1) {
                        items[itemIndex].status = 'matched';
                        setStorage('foundit_items', items);
                        showNotification(`Item claim initiated! Please visit the drop-off location to verify ownership. The item has been removed from the public gallery.`);
                        loadFoundItems();
                    }
                });
            });
        }
        
        function loadMyItems() {
            const myLostContainer = document.getElementById('my-lost-items');
            const myFoundContainer = document.getElementById('my-found-items');
            
            const allItems = getStorage('foundit_items') || [];
            const myLostItems = allItems.filter(item => item.reporterId === currentUser.id && item.type === 'lost');
            const myFoundItems = allItems.filter(item => item.reporterId === currentUser.id && item.type === 'found');

            myLostContainer.innerHTML = myLostItems.length === 0 ? '<p class="text-gray-500 dark:text-gray-400">You have not reported any lost items.</p>' : '';
            myFoundContainer.innerHTML = myFoundItems.length === 0 ? '<p class="text-gray-500 dark:text-gray-400">You have not reported any found items.</p>' : '';

            myLostItems.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                el.innerHTML = `<div><p class="font-bold text-gray-800 dark:text-white">${item.name}</p><p class="text-sm text-gray-500 dark:text-gray-400">Status: ${item.status}</p></div><button class="bg-red-500 text-white text-sm px-3 py-1 rounded hover:bg-red-600 delete-btn" data-id="${item.id}">Delete</button>`;
                myLostContainer.appendChild(el);
            });

            myFoundItems.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                el.innerHTML = `<div><p class="font-bold text-gray-800 dark:text-white">${item.name}</p><p class="text-sm text-gray-500 dark:text-gray-400">Status: ${item.status}</p></div><button class="bg-red-500 text-white text-sm px-3 py-1 rounded hover:bg-red-600 delete-btn" data-id="${item.id}">Delete</button>`;
                myFoundContainer.appendChild(el);
            });

            document.querySelectorAll('#my-lost-items .delete-btn, #my-found-items .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteItem(e.target.dataset.id, loadMyItems));
            });
        }
        
        // --- ADMIN PANEL LOGIC ---

        function attachAdminListeners() {
            const tabs = document.querySelectorAll('.admin-tab');

            function switchTab(tabButton) {
                tabs.forEach(t => t.classList.remove('active'));
                tabButton.classList.add('active');
                const tabName = tabButton.dataset.tab;
                
                switch(tabName) {
                    case 'items': renderAdminItems(); break;
                    case 'users': renderAdminUsers(); break;
                    case 'feedback': renderAdminFeedback(); break;
                    case 'matching': renderAdminMatching(); break;
                }
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab));
            });
            switchTab(document.querySelector('.admin-tab.active'));

            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = '<i class="fas fa-sun text-xl"></i>';
            const moonIcon = '<i class="fas fa-moon text-xl"></i>';

            const updateThemeIcon = () => {
                themeToggle.innerHTML = document.documentElement.classList.contains('dark') ? sunIcon : moonIcon;
            };
            
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcon();
            });
            
            document.getElementById('notification-bell')?.addEventListener('click', () => showNotification('No new notifications.', true));
            updateThemeIcon();
        }
        
        function getStatusBadge(status) {
            const statuses = {
                available: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
                reported: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
                matched: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
                returned: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
                invalid: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'
            };
            const colorClass = statuses[status] || 'bg-gray-200 text-gray-800';
            return `<span class="${colorClass} text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">${status}</span>`;
        }

        function renderAdminItems() {
            const contentArea = document.getElementById('admin-content-area');
            const allItems = getStorage('foundit_items') || [];
            const sortedItems = allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            let itemsHtml = sortedItems.map(item => `
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <td class="px-6 py-4 font-medium whitespace-nowrap text-gray-900 dark:text-white">${item.name} <span class="text-xs ${item.type === 'found' ? 'text-green-500' : 'text-yellow-500'}">(${item.type})</span></td>
                    <td class="px-6 py-4">${item.reporterEmail}</td>
                    <td class="px-6 py-4">${new Date(item.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4">${getStatusBadge(item.status)}</td>
                    <td class="px-6 py-4 text-right">
                        <select class="status-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" data-id="${item.id}">
                            <option value="available" ${item.status === 'available' ? 'selected' : ''}>Available</option>
                            <option value="reported" ${item.status === 'reported' ? 'selected' : ''}>Reported</option>
                            <option value="matched" ${item.status === 'matched' ? 'selected' : ''}>Matched</option>
                            <option value="returned" ${item.status === 'returned' ? 'selected' : ''}>Returned</option>
                            <option value="invalid" ${item.status === 'invalid' ? 'selected' : ''}>Invalid</option>
                        </select>
                        <button class="font-medium text-red-600 dark:text-red-500 hover:underline ml-4 delete-btn" data-id="${item.id}">Delete</button>
                    </td>
                </tr>
            `).join('');

            contentArea.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">All Items</h2>
                        <button id="export-csv-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">Export as CSV</button>
                    </div>
                    <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Item Name</th>
                                    <th scope="col" class="px-6 py-3">Reporter</th>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                    </div>
                </div>`;
            
            contentArea.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteItem(e.target.dataset.id, renderAdminItems)));
            contentArea.querySelectorAll('.status-select').forEach(sel => sel.addEventListener('change', (e) => updateItemStatus(e.target.dataset.id, e.target.value)));
            contentArea.querySelector('#export-csv-btn').addEventListener('click', exportItemsToCSV);
        }
        
        function renderAdminUsers() {
            const contentArea = document.getElementById('admin-content-area');
            const usersObject = getStorage('foundit_users') || {};
            const users = Object.values(usersObject);
            
            let usersHtml = users.map(user => `
                <tr class="user-row bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" data-userid="${user.id}">
                    <td class="p-4 w-4">
                        <div class="flex items-center">
                            <input type="checkbox" class="user-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500" data-email="${user.email}" onclick="event.stopPropagation()">
                        </div>
                    </td>
                    <td class="px-6 py-4 font-medium whitespace-nowrap text-gray-900 dark:text-white">${user.name}</td>
                    <td class="px-6 py-4">${user.collegeId}</td>
                    <td class="px-6 py-4">${user.email}</td>
                    <td class="px-6 py-4">${user.id === 'admin456' ? 'Admin' : 'User'}</td>
                    <td class="px-6 py-4 text-right">
                        ${user.id !== 'admin456' ? `<button class="font-medium text-red-600 dark:text-red-500 hover:underline delete-user-btn" data-email="${user.email}" onclick="event.stopPropagation()">Delete</button>` : ''}
                    </td>
                </tr>
            `).join('');

            contentArea.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">All Users</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                         <input type="text" id="user-search" class="p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 w-full sm:w-1/3" placeholder="Search by email...">
                         <button id="bulk-message-btn" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">Send Message to Selected</button>
                    </div>
                     <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                        <table id="admin-users-table" class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="p-4"><input type="checkbox" id="select-all-users"></th>
                                    <th scope="col" class="px-6 py-3">Name</th>
                                    <th scope="col" class="px-6 py-3">College ID</th>
                                    <th scope="col" class="px-6 py-3">Email</th>
                                    <th scope="col" class="px-6 py-3">Role</th>
                                    <th scope="col" class="px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody>${usersHtml}</tbody>
                        </table>
                    </div>
                </div>`;
            
            document.getElementById('user-search').addEventListener('keyup', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#admin-users-table tbody tr').forEach(row => {
                    const email = row.cells[3].textContent.toLowerCase();
                    row.style.display = email.includes(searchTerm) ? '' : 'none';
                });
            });

            const selectAllCheckbox = document.getElementById('select-all-users');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            selectAllCheckbox.addEventListener('change', (e) => {
                userCheckboxes.forEach(cb => cb.checked = e.target.checked);
            });
            
            document.getElementById('bulk-message-btn').addEventListener('click', () => {
                const selectedEmails = [...userCheckboxes].filter(cb => cb.checked).map(cb => cb.dataset.email);
                if (selectedEmails.length === 0) {
                    showNotification("No users selected.", true);
                    return;
                }
                const message = prompt(`Enter message for ${selectedEmails.length} user(s):`);
                if (message) {
                    showNotification(`Message simulated as sent to selected users.`);
                }
            });

            document.querySelectorAll('.user-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    showUserDetailsModal(e.currentTarget.dataset.userid);
                });
            });

            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleDeleteUser(e.target.dataset.email);
                });
            });
        }

        function handleDeleteUser(email) {
            showNotification(`Are you sure you want to delete the user ${email}? This will also delete all items they have reported. This action cannot be undone. <br/><br/> <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Yes, Delete User</button>`, false);
            document.getElementById('confirm-delete-btn').onclick = () => {
                const users = getStorage('foundit_users');
                delete users[email];
                setStorage('foundit_users', users);

                const items = getStorage('foundit_items');
                const updatedItems = items.filter(item => item.reporterEmail !== email);
                setStorage('foundit_items', updatedItems);

                showNotification('User and their items have been deleted.');
                renderAdminUsers();
            };
        }

        function showUserDetailsModal(userId) {
            const users = getStorage('foundit_users');
            const user = Object.values(users).find(u => u.id === userId);
            if (!user) return;
            
            const modal = document.getElementById('user-details-modal');
            const modalBody = document.getElementById('user-modal-body');
            modalBody.innerHTML = `
                <p><strong class="text-gray-500 dark:text-gray-400">Name:</strong> ${user.name}</p>
                <p><strong class="text-gray-500 dark:text-gray-400">Email:</strong> ${user.email}</p>
                <p><strong class="text-gray-500 dark:text-gray-400">College ID:</strong> ${user.collegeId}</p>
                <p><strong class="text-gray-500 dark:text-gray-400">Phone:</strong> ${user.phoneNumber}</p>
                <p><strong class="text-gray-500 dark:text-gray-400">Address:</strong> ${user.address}</p>
                <p><strong class="text-gray-500 dark:text-gray-400">Internal User ID:</strong> ${user.id}</p>
            `;
            modal.style.display = 'flex';
            modal.classList.add('items-center', 'justify-center');
        }
        
        function renderAdminFeedback() {
             const contentArea = document.getElementById('admin-content-area');
             const feedbackEntries = (getStorage('foundit_feedback') || []).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

             let feedbackHtml = feedbackEntries.map(fb => `
                 <div class="p-4 border-b dark:border-gray-700">
                     <p class="font-semibold text-gray-800 dark:text-gray-200">${fb.message}</p>
                     <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">From: ${fb.userEmail} on ${new Date(fb.createdAt).toLocaleDateString()}</p>
                 </div>
             `).join('');

             if (feedbackEntries.length === 0) {
                 feedbackHtml = '<p class="p-4 text-gray-500">No feedback submitted yet.</p>';
             }

             contentArea.innerHTML = `
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                     <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">User Feedback</h2>
                     <div class="space-y-2">${feedbackHtml}</div>
                 </div>
             `;
        }

        function renderAdminMatching() {
            const contentArea = document.getElementById('admin-content-area');
            const allItems = getStorage('foundit_items') || [];
            const lostItems = allItems.filter(item => item.type === 'lost' && item.status === 'reported');
            const foundItems = allItems.filter(item => item.type === 'found' && item.status === 'available');

            let lostItemsHtml = lostItems.map(item => `
                <div class="p-4 border dark:border-gray-700 rounded-lg mb-4">
                    <h4 class="font-bold text-lg text-gray-900 dark:text-white">${item.name}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Lost at: ${item.location} | By: ${item.reporterEmail}</p>
                    <p class="my-2 text-sm text-gray-600 dark:text-gray-300">${item.description}</p>
                    <div class="mt-3 border-t dark:border-gray-700 pt-3">
                        <h5 class="font-semibold text-sm mb-2 text-gray-800 dark:text-gray-200">Potential Matches:</h5>
                        ${getMatchSuggestions(item, foundItems)}
                    </div>
                </div>
            `).join('');

            if(lostItems.length === 0) {
                 lostItemsHtml = '<p class="p-4 text-gray-500">No active lost item reports to match.</p>';
            }

            contentArea.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Item Match Suggestions</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">This tool provides a simulated match score based on keyword similarity between lost and found item descriptions.</p>
                    <div>${lostItemsHtml}</div>
                </div>`;
        }
        
        function getMatchSuggestions(lostItem, foundItems) {
            function calculateMatchScore(text1, text2) {
                const words1 = new Set(text1.toLowerCase().replace(/[,.]/g, '').split(/\s+/));
                const words2 = new Set(text2.toLowerCase().replace(/[,.]/g, '').split(/\s+/));
                const intersection = new Set([...words1].filter(x => words2.has(x)));
                const union = new Set([...words1, ...words2]);
                return union.size === 0 ? 0 : Math.round((intersection.size / union.size) * 100);
            }
            
            const suggestions = foundItems.map(foundItem => {
                const nameScore = calculateMatchScore(lostItem.name, foundItem.name);
                const descScore = calculateMatchScore(lostItem.description, foundItem.description);
                const totalScore = Math.round(nameScore * 0.6 + descScore * 0.4);
                return { item: foundItem, score: totalScore };
            }).filter(s => s.score > 10).sort((a,b) => b.score - a.score);

            if(suggestions.length === 0) {
                return '<p class="text-sm text-gray-400">No potential matches found.</p>';
            }

            return suggestions.map(s => `
                <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded-md mb-2">
                    <div>
                        <p class="font-semibold text-sm text-gray-800 dark:text-gray-200">${s.item.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Found at: ${s.item.location}</p>
                    </div>
                    <div class="text-right">
                         <span class="font-bold text-lg ${s.score > 60 ? 'text-green-500' : 'text-yellow-500'}">${s.score}%</span>
                         <p class="text-xs text-gray-500 dark:text-gray-400">Match Score</p>
                    </div>
                </div>
            `).join('');
        }

        function updateItemStatus(id, newStatus) {
            let items = getStorage('foundit_items');
            const itemIndex = items.findIndex(item => item.id === id);
            if(itemIndex > -1) {
                items[itemIndex].status = newStatus;
                setStorage('foundit_items', items);
                showNotification(`Item ${id.substring(0,8)} status updated to ${newStatus}.`, true);
                renderAdminItems(); 
            }
        }
        
        function handleDeleteItem(id, refreshFunction) {
            const items = getStorage('foundit_items');
            const item = items.find(i => i.id === id);
            if (item && item.status === 'returned') {
                showNotification("Cannot delete an item that has already been returned.", true);
                return;
            }
            showNotification(`Are you sure you want to delete this item? This action cannot be undone. <br/><br/> <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Yes, Delete</button>`, false);
            document.getElementById('confirm-delete-btn').onclick = () => {
                let currentItems = getStorage('foundit_items');
                const updatedItems = currentItems.filter(item => item.id !== id);
                setStorage('foundit_items', updatedItems);
                showNotification('Item deleted.');
                refreshFunction();
            };
        }

        function exportItemsToCSV() {
            const headers = ['ID', 'Type', 'Name', 'Description', 'Location', 'DropoffLocation', 'Status', 'ReporterEmail', 'CreatedAt'];
            const csvRows = [headers.join(',')];
            const allItems = getStorage('foundit_items') || [];

            for(const item of allItems) {
                const values = headers.map(header => {
                    const key = header.charAt(0).toLowerCase() + header.slice(1);
                    const escaped = ('' + (item[key] || '')).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'foundit_items_report.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- UTILITY & CHATBOT ---
        function showNotification(message, autoClose = true) {
            const modal = document.getElementById('notification-modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.innerHTML = message;
            modal.style.display = 'flex';
            modal.classList.add('items-center', 'justify-center');
            
            const close = () => {
                if (modal.style.display === 'flex') {
                   modal.style.display = 'none';
                   modal.classList.remove('items-center', 'justify-center');
                }
            };

            if (autoClose) {
                setTimeout(close, 3000);
            }
        }
        document.getElementById('modal-close').addEventListener('click', () => {
            const modal = document.getElementById('notification-modal');
            modal.style.display = 'none';
            modal.classList.remove('items-center', 'justify-center');
        });

        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotWindow = document.getElementById('chatbot-window');
        const closeChatbot = document.getElementById('close-chatbot');
        const chatbotSend = document.getElementById('chatbot-send');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotMessages = document.getElementById('chatbot-messages');

        chatbotToggle.addEventListener('click', () => chatbotWindow.classList.toggle('hidden'));
        closeChatbot.addEventListener('click', () => chatbotWindow.classList.add('hidden'));
        chatbotSend.addEventListener('click', handleChatSend);
        chatbotInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(); });

        function handleChatSend() {
            const userInput = chatbotInput.value.trim().toLowerCase();
            if (!userInput) return;

            addChatMessage(chatbotInput.value, 'user');
            chatbotInput.value = '';
            
            let botResponse;
            if (userInput.includes('lost')) {
                botResponse = "If you've lost an item, you can report it from your dashboard. Click 'Lost Something?' to get started.";
            } else if (userInput.includes('found')) {
                botResponse = "That's great! You can report a found item from your dashboard. Be sure to include a picture and drop it off at a designated location.";
            } else if (userInput.includes('claim')) {
                botResponse = "To claim an item, go to the 'View Found Items' gallery. If you see your item, click 'Claim' and follow the instructions to verify ownership with an admin.";
            } else if (userInput.includes('password') || userInput.includes('account')) {
                botResponse = "You can manage your account details and change your password from the 'My Profile' section on your dashboard.";
            } else {
                botResponse = "I can help with questions about reporting lost items, finding items, or claiming them. How can I assist you?";
            }
            
            setTimeout(() => addChatMessage(botResponse, 'bot'), 500);
        }

        function addChatMessage(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-3 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-lg max-w-xs ${sender === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200'}`;
            messageBubble.innerHTML = `<p>${message}</p>`;
            messageWrapper.appendChild(messageBubble);
            chatbotMessages.appendChild(messageWrapper);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        // --- INITIALIZE APP ---
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        
        initializeStorage();

        window.addEventListener('hashchange', router);
        document.addEventListener('DOMContentLoaded', router);

    </script>
</body>
</html>
